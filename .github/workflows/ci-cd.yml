name: CI/CD Pipeline (Blue-Green)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # 1. Build & Test Server
  build-server:
    name: Build Server
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./server
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: server/package-lock.json
    - name: Install dependencies
      run: npm install
    - name: Build
      run: npm run build

  # 2. Build & Test Client
  build-client:
    name: Build Client
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./client
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: 20
        cache: 'npm'
        cache-dependency-path: client/package-lock.json
    - name: Install dependencies
      run: |
        rm -rf node_modules package-lock.json
        npm install
        npm install @rollup/rollup-linux-x64-gnu --save-optional --no-save
    - name: Build
      run: VITE_API_URL=http://localhost:3000/api npm run build

  # 3. Deploy with Blue-Green Strategy
  deploy:
    name: Deploy (Blue-Green)
    needs: [build-server, build-client]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
    - name: Blue-Green Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        command_timeout: 30m
        script_stop: true
        script: |
          cd parking-app
          git pull
          
          # Copy example env if not exists
          if [ ! -f .env ]; then
            cp .env.example .env
          fi
          
          # Stop old traditional compose if running (first-time migration)
          echo "ðŸ§¹ Cleaning up old containers..."
          docker compose down || true
          
          # Read current active color
          CURRENT_COLOR=$(cat .deploy-color 2>/dev/null || echo "blue")
          
          # Determine next color
          if [ "$CURRENT_COLOR" = "blue" ]; then
            NEXT_COLOR="green"
            OLD_COLOR="blue"
          else
            NEXT_COLOR="blue"
            OLD_COLOR="green"
          fi
          
          echo "ðŸ”„ Current: $CURRENT_COLOR -> Deploying: $NEXT_COLOR"
          
          # Ensure infrastructure is running
          docker compose -f docker-compose.blue-green.yml up -d postgres client nginx
          
          # Build and start new version
          echo "ðŸ“¦ Building $NEXT_COLOR..."
          docker compose -f docker-compose.blue-green.yml build server-$NEXT_COLOR
          
          echo "ðŸš€ Starting $NEXT_COLOR..."
          docker compose -f docker-compose.blue-green.yml --profile $NEXT_COLOR up -d server-$NEXT_COLOR
          
          # Wait for container to be ready
          echo "â³ Waiting for healthcheck..."
          sleep 40
          
          # Check health
          HEALTH=$(docker exec parking_server_$NEXT_COLOR curl -sf http://localhost:3000/health 2>/dev/null || echo "FAILED")
          
          if [ "$HEALTH" = "FAILED" ]; then
            echo "âŒ Health check failed! Aborting deployment."
            docker compose -f docker-compose.blue-green.yml --profile $NEXT_COLOR stop server-$NEXT_COLOR
            exit 1
          fi
          
          echo "âœ… $NEXT_COLOR is healthy!"
          
          # Double-check container is still running (not restarting)
          echo "ðŸ” Verifying container stability..."
          sleep 5
          CONTAINER_STATUS=$(docker inspect --format='{{.State.Status}}' parking_server_$NEXT_COLOR)
          
          if [ "$CONTAINER_STATUS" != "running" ]; then
            echo "âŒ Container is $CONTAINER_STATUS! Showing logs:"
            docker logs --tail 50 parking_server_$NEXT_COLOR
            echo "Aborting deployment."
            docker compose -f docker-compose.blue-green.yml --profile $NEXT_COLOR stop server-$NEXT_COLOR
            exit 1
          fi
          
          # Switch traffic in NGINX config
          echo "ðŸ”ƒ Switching traffic to $NEXT_COLOR..."
          
          # Update nginx config
          if [ "$NEXT_COLOR" = "green" ]; then
            sed -i 's/server parking_server_blue:3000;/# server parking_server_blue:3000;/' nginx/conf.d/default.conf
            sed -i 's/# server parking_server_green:3000;/server parking_server_green:3000;/' nginx/conf.d/default.conf
          else
            sed -i 's/server parking_server_green:3000;/# server parking_server_green:3000;/' nginx/conf.d/default.conf
            sed -i 's/# server parking_server_blue:3000;/server parking_server_blue:3000;/' nginx/conf.d/default.conf
          fi
          
          # Reload nginx (graceful, no dropped connections)
          docker exec parking_nginx nginx -s reload
          
          echo "âœ… Traffic switched to $NEXT_COLOR!"
          
          # Wait a bit then stop old version
          sleep 5
          echo "ðŸ›‘ Stopping old $OLD_COLOR..."
          docker compose -f docker-compose.blue-green.yml --profile $OLD_COLOR stop server-$OLD_COLOR || true
          
          # Update state file
          echo "$NEXT_COLOR" > .deploy-color
          
          # Cleanup
          docker image prune -f
          
          echo "ðŸŽ‰ Blue-Green deployment complete! Active: $NEXT_COLOR"
